# Design: 回合制与棋将血量、怪物 AI

## Context

- **当前状态**：FightBoard 管理格子、单位放置与点击；棋将（ChessHero）可移动/攻击/技能，敌将（ChessEnemy）有固定血量与 TakeDamage，无移动与主动攻击；无回合概念，玩家可无限操作。
- **约束**：沿用 Godot 4 + C#、Excel 配置（General.xlsx 等）、现有节点与 API；不引入新运行时依赖。
- **相关方**：玩法逻辑集中在 FightBoard、ChessHero、ChessEnemy；配置由 GeneralConfigLoader / HeroConfig 与 OPENSPEC.md 约定。

## Goals / Non-Goals

**Goals:**

- 实现我方/怪物方轮流回合；每回合双方各有固定两次“行为”（每次行为 = 一次移动或一次攻击）。
- 棋将拥有血量，初始值来自 General.xlsx 的 GHp 列，战斗中可被怪物攻击扣减并显示。
- 怪物方回合内，每只怪物按 AI 执行最多两次行为：优先攻击最近棋将（伤害 1），无法攻击则移动向最近棋将；行为用尽或无可执行目标则结束该怪物回合。

**Non-Goals:**

- 不在本变更内实现技能对血量的影响、治疗、护甲等扩展数值；不改变棋将攻击力/攻击距离的配置方式。
- 怪物 AI 仅做“最近单位 + 能打则打否则走”的简单策略，不做路径规划优化或多目标选择策略。

## Decisions

1. **回合与行为计数存放位置**  
   - **决策**：在 FightBoard（或由 FightBoard 持有的轻量 TurnState 对象）内维护当前阵营（Player / Monster）、本回合剩余行为次数、当前正在执行行为的怪物索引（怪物回合时）。  
   - **理由**：FightBoard 已持有所有单位与格子，点击与移动/攻击入口也在此，集中在一处便于在每次操作后更新计数并切换回合。  
   - **备选**：独立 TurnManager 节点。不采纳以保持单点控制、减少跨节点同步。

2. **“两次行为”的粒度**  
   - **决策**：每次“移动”或“攻击”各消耗 1 次行为；同一回合内可任意顺序（例如先攻击再移动、或两次移动）。  
   - **理由**：与 proposal 一致，实现简单、易于 UI 展示（如剩余行动次数）。

3. **怪物“最近单位”定义与目标**  
   - **决策**：最近单位指“曼哈顿距离最近的棋将（ChessHero）”；若存在多个等距则取其一（如按行列序）。怪物只以棋将为攻击/移动目标，不攻击其他怪物。  
   - **理由**：与“怪物攻击棋将”的语义一致；FightBoard 已有 ManhattanDistance 与格子遍历，复用即可。  
   - **备选**：将“敌将”也纳入目标。不采纳以保持当前敌我分明、简化 AI。

4. **怪物移动与攻击能力**  
   - **决策**：怪物攻击距离定为 1（邻格）；移动距离定为 1（每步一格）；每回合最多两次行为，即最多两次 1 格移动或两次 1 格攻击或一次移动+一次攻击。  
   - **理由**：与“伤害为 1”的简单设定匹配；实现上可复用 GetCellsWithinRange(row, col, 1) 与现有移动/伤害 API。  
   - **备选**：从配置表读怪物攻击/移动距离。留作后续扩展，本变更不读表。

5. **棋将血量数据流**  
   - **决策**：HeroConfig 新增 GHp 字段；GeneralConfigLoader 解析 General.xlsx 新列（表头“血量”或“GHp”）；ApplyToHero 时设置棋将初始血量；ChessHero 内部维护 CurrentHp、MaxHp（或仅 CurrentHp，初始值即 MaxHp），提供 TakeDamage 与血量显示（如 Label 或进度条）。  
   - **理由**：与现有配置驱动风格一致；OPENSPEC.md 已约定表头与列含义，只需扩展一列。

6. **怪物攻击棋将的结算**  
   - **决策**：ChessHero 增加 TakeDamage(int amount)；FightBoard 或怪物 AI 在判定“可攻击到棋将”的格子上调用 ApplyDamageToCells 或等效逻辑，对棋将所在格调用 hero.TakeDamage(1)。若棋将死亡则从棋盘移除并 QueueFree（与 ChessEnemy 死亡处理类似）。  
   - **理由**：与现有 ApplyDamageToCells（仅敌将）对称；扩展为“按格子内单位类型扣血”或单独“对棋将造成伤害”接口均可。

## Risks / Trade-offs

- **[风险] 怪物回合内多只怪物顺序执行可能带来长等待**  
  → 缓解：先实现顺序执行；若需可后续加短暂延时或动画，本变更不强制。

- **[风险] 配置表缺少 GHp 列时棋将血量未定义**  
  → 缓解：解析时若缺列或非数字则默认 GHp=1（或合理默认值），并在文档中说明必填。

- **[ trade-off ] 怪物移动为简单“向最近棋将走一步”**  
  → 接受：不做寻路，仅选曼哈顿距离减少的一格移动；足够满足“若不可攻击则移动”的提案要求。

## Migration Plan

- 在 General.xlsx 中新增一列“血量”或“GHp”，为现有棋将 ID 行补填数值。
- 部署顺序：先发布支持 GHp 的配置与棋将血量逻辑，再开启回合与怪物 AI，避免半成品状态下玩家可无限操作而怪物不动。
- 回滚：若需回滚，可关闭回合切换（例如仅玩家回合），保留棋将血量与配置扩展不影响旧逻辑。

## Open Questions

- 无。若后续为怪物增加配置表（攻击/移动距离、血量），可在新变更中再设计。
